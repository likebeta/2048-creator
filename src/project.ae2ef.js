__require=function e(t,o,r){function c(n,i){if(!o[n]){if(!t[n]){var a=n.split("/");if(a=a[a.length-1],!t[a]){var l="function"==typeof __require&&__require;if(!i&&l)return l(a,!0);if(s)return s(a,!0);throw new Error("Cannot find module '"+n+"'")}}var u=o[n]={exports:{}};t[n][0].call(u.exports,function(e){return c(t[n][1][e]||e)},u,u.exports,e,t,o,r)}return o[n].exports}for(var s="function"==typeof __require&&__require,n=0;n<r.length;n++)c(r[n]);return c}({app:[function(e,t,o){"use strict";var r;function c(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}cc._RF.push(t,"00c37AyZihIQqHqJ8akzelR","app"),e("boot");var s=null;cc.Class((c(r={extends:cc.Component,properties:{loading:cc.Node,best_score:cc.Label,score:cc.Label,block_gap:7.5,replay_btn:cc.Button,block_prefab:cc.Prefab,game:cc.Layout,_blocks:[],_tiles:[],_free_tiles:[],_is_animation:!1,_game_over:!1,_game_result:null},onLoad:function(){var e=this;cc.sys.platform===cc.sys.WECHAT_GAME?ctx.storage.login(function(t){console.log("user.login:",t),e.fetch_remote_data(1)}):e._init_scene()},fetch_remote_data:function(e){var t=this;ctx.storage.get_current_user(function(o){console.log("user.current:",o),o.errCode?t.on_fatal_error("fetch.data",o.errMsg):o.data?(s=o.data,t._init_scene()):ctx.storage.new_user({score:0},function(o){console.log("user.new:",o),o.errCode?t.on_fatal_error("user.new",o.errMsg):1===e?t.fetch_remote_data(2):t.on_fatal_error("fetch.data","\u83b7\u53d6\u4e0d\u5230\u6570\u636e")})})},on_fetch_remote_data_complete:function(e){this._init_scene()},on_fatal_error:function(e,t){console.log(e,"failed, restart",t),cc.game.end()},_init_scene:function(){this.loading.active=!1,this.addInputControl(),this.addTouchControl(this.game),this.replay_btn.node.on("click",this.rePlay,this);for(var e=0;e<16;++e){var t=cc.instantiate(this.block_prefab);this.game.node.addChild(t),this._blocks.push(t)}this.resetBlocks(),this.loadData()},check_auth_setting:function(e){var t=this;console.log("setting",e),e?e["scope.userInfo"]?t.fetch_remote_data():wx.openSetting({success:function(e){t.check_auth_setting(e.authSetting)},fail:function(e){t.on_fatal_error("wx.openSetting",e)}}):(console.log("get setting"),wx.getSetting({success:function(e){t.check_auth_setting(e.authSetting)},fail:function(e){t.on_fatal_error("wx.getSetting",e)}}))},resetBlocks:function(){var e=this;this._blocks.forEach(function(t,o){var r=t.getComponent("tile");e._tiles.push(r),e.addFreeBlock(o),r.set_value(0)});var t=this.getFreeBlock();this._tiles[t].set_value(2);var o=this.getFreeBlock();this._tiles[o].set_value(2)},loadData:function(){var e=cc.sys.localStorage.getItem("game.2048.data")||"";if(e){if(4!==(e=JSON.parse(e)).number)return console.log("block number not equal"),!0;e.score_info&&this.recoverScore(e.score_info),e.block_info&&this.recoverBlocks(e.block_info),void 0!==e.game_over&&(this._game_over=Boolean(e.game_over),this._game_result=e.game_result)}if(cc.sys.platform===cc.sys.WECHAT_GAME){var t=s.score;t&&t>this.best_score.string&&(this.best_score.string=t,console.log("recover best score from remote",this.best_score.string))}return!0},saveData:function(){var e={number:4,score_info:this.snapshotScore(),block_info:this.snapshotBlocks()};return this._game_result&&(e.game_result=this.game_result),this.game_over&&(e.game_over=this.game_over),e=JSON.stringify(e),cc.sys.localStorage.setItem("game.2048.data",e),!0},snapshotScore:function(){return{best_score:parseInt(this.best_score.string),score:parseInt(this.score.string)}},snapshotBlocks:function(){for(var e=[],t=0;t<16;++t){var o=this._tiles[t].get_value();e.push(o)}return{board:e}},recoverScore:function(e){return e.best_score&&(console.log("recover best score from local",e.best_score),this.best_score.string=e.best_score),e.score&&(console.log("recover score to",e.score),this.score.string=e.score),!0},recoverBlocks:function(e){if(void 0!==e.board){console.log("recover board to",e.board),this._free_tiles=[];for(var t=0;t<e.board.length;++t)this._tiles[t].set_value(e.board[t]),0===e.board[t]&&this._free_tiles.push(t)}return console.log("recover free block to",this._free_tiles),!0},addInputControl:function(){var e=this;cc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN,function(t){var o=!1;switch(t.keyCode){case cc.KEY.up:o=e.handleAction("up");break;case cc.KEY.down:o=e.handleAction("down");break;case cc.KEY.left:o=e.handleAction("left");break;case cc.KEY.right:o=e.handleAction("right")}o.success&&(o.score&&e.incrScore(o.score),e.saveData())},this)},addTouchControl:function(e){var t,o=this;e.node.on(cc.Node.EventType.TOUCH_START,function(e){return t=e.getLocation(),!0},e),e.node.on(cc.Node.EventType.TOUCH_END,function(e){var r=e.getLocation(),c=r.x-t.x,s=r.y-t.y,n=!1;Math.abs(c)>=Math.abs(s)?c<=-o.block_gap?n=o.handleAction("left"):c>=o.block_gap&&(n=o.handleAction("right")):s<=-o.block_gap?n=o.handleAction("down"):s>=o.block_gap&&(n=o.handleAction("up")),n.success&&(n.score&&o.incrScore(n.score),o.saveData())},e)},handleAction:function(e){if(this._is_animation)return console.log("is animation ..."),!1;if("lose"===this._game_result)return console.log("you lost, game over -_-!"),!1;if("win"===this._game_result)return console.log("you won, game over ^_^!"),!1;console.log(e);for(var t=[],o=0;o<16;++o)t.push(this._tiles[o]);var r=!1;switch(e){case"left":r=this.moveLeft(t);break;case"right":r=this.moveRight(t);break;case"down":r=this.moveDown(t);break;case"up":r=this.moveUp(t)}return r.success&&(this.randomNewBlock(),0===this._free_tiles.length&&(this.moveLeft(t,!0)||this.moveRight(t,!0)||this.moveUp(t,!0)||this.moveDown(t,!0)||(this._game_result="lose",console.log("you lose, game over")))),r},incrScore:function(e){var t=e+parseInt(this.score.string);if(this.score.string=t,t>this.best_score.string&&(this.best_score.string=t,"lose"===this._game_result&&cc.sys.platform===cc.sys.WECHAT_GAME)){var o=s.score;console.log("try to save to remote",t,o),(void 0===o||t>o)&&(s.score=t,ctx.storage.update_user({score:t},function(e){console.log("user.update",e)}))}},addFreeBlock:function(e){this._free_tiles.push(e)},getFreeBlock:function(){var e=utils.rand(1e4)%this._free_tiles.length,t=this._free_tiles[e];return this.removeFreeBlockByIndex(e),t},removeFreeBlockByIndex:function(e){this._free_tiles[e]=this._free_tiles[0],this._free_tiles.shift()},removeFreeBlock:function(e){for(var t=0;t<this._free_tiles.length;++t)if(this._free_tiles[t]===e){this.removeFreeBlockByIndex(t);break}}},"removeFreeBlockByIndex",function(e){this._free_tiles[e]=this._free_tiles[0],this._free_tiles.shift()}),c(r,"randomNewBlock",function(){if(0===this._free_tiles.length)return console.log("no free block exist, maybe win"),null;var e=this.getFreeBlock(),t=this._tiles[e],o=this._blocks[e],r=cc.instantiate(this.block_prefab);o.addChild(r,99),r.setPosition(0,0);var c=utils.rand(100)<=10?4:2;t.set_fake_value(c),r.getComponent("tile").set_value(c),r.setScale(.2),this._is_animation=!0;var s=new cc.ScaleTo(.2,1),n=new cc.CallFunc(this.animationEnd,this,[t,c]),i=new cc.Sequence(s,n);return r.runAction(i),t}),c(r,"animationEnd",function(e,t){var o=t[0],r=t[1];e.removeFromParent(!0),o.set_value(r),this._is_animation=!1}),c(r,"rePlay",function(e){if(this._is_animation)return console.log("is animation, rePlay failed"),!1;if(cc.sys.platform===cc.sys.WECHAT_GAME){var t=parseInt(this.best_score.string),o=s.score;console.log("try to save to remote",t,o),(void 0===o||t>o)&&(s.score=t,ctx.storage.update_user({score:t},function(e){console.log("user.update",e)}))}return console.log("rePlay"),this._game_over=!1,this._game_result=null,this._is_animation=!1,this._tiles=[],this._free_tiles=[],this.score.string=0,this.resetBlocks(),this.saveData(),!0}),c(r,"moveLeft",function(e,t){for(var o=!1,r=0,c=0;c<4;++c)for(var s=-1,n=0,i=0,a=1;a<4;++a){var l=a+4*c,u=e[l].get_value();if(!(u<=0)){for(var _=s,f=a-1;f>s;--f)if(!((i=e[n=f+4*c].get_value())<=0)){if(i===u){if(t)return!0;r+=this.combineBlocks(e,l,n),s=f,o+=!0;break}if(f+1===a){s=f;break}if(t)return!0;n=f+1+4*c,this.combineBlocks(e,l,n),s=f,o=!0;break}if(s===_&&s+1!==a){if(t)return!0;n=s+1+4*c,this.combineBlocks(e,l,n),o=!0}}}return t?o:{success:o,score:r}}),c(r,"moveRight",function(e,t){for(var o=!1,r=0,c=0;c<4;++c)for(var s=4,n=0,i=0,a=2;a>=0;--a){var l=a+4*c,u=e[l].get_value();if(!(u<=0)){for(var _=s,f=a+1;f<s;++f)if(!((i=e[n=f+4*c].get_value())<=0)){if(i===u){if(t)return!0;r+=this.combineBlocks(e,l,n),s=f,o=!0;break}if(f-1===a){s=f;break}if(t)return!0;n=f-1+4*c,this.combineBlocks(e,l,n),s=f,o=!0;break}if(s===_&&s-1!==a){if(t)return!0;n=s-1+4*c,this.combineBlocks(e,l,n),o=!0}}}return t?o:{success:o,score:r}}),c(r,"moveUp",function(e,t){for(var o=!1,r=0,c=0;c<4;++c)for(var s=4,n=0,i=0,a=2;a>=0;--a){var l=c+4*a,u=e[l].get_value();if(!(u<=0)){for(var _=s,f=a+1;f<s;++f)if(!((i=e[n=c+4*f].get_value())<=0)){if(i===u){if(t)return!0;r+=this.combineBlocks(e,l,n),s=f,o=!0;break}if(f-1===a){s=f;break}if(t)return!0;n=c+4*(f-1),this.combineBlocks(e,l,n),s=f,o=!0;break}if(s===_&&s-1!==a){if(t)return!0;n=c+4*(s-1),this.combineBlocks(e,l,n),o=!0}}}return t?o:{success:o,score:r}}),c(r,"moveDown",function(e,t){for(var o=!1,r=0,c=0;c<4;++c)for(var s=-1,n=0,i=0,a=1;a<4;++a){var l=c+4*a,u=e[l].get_value();if(!(u<=0)){for(var _=s,f=a-1;f>s;--f)if(!((i=e[n=c+4*f].get_value())<=0)){if(i===u){if(t)return!0;r+=this.combineBlocks(e,l,n),s=f,o=!0;break}if(f+1===a){s=f;break}if(t)return!0;n=c+4*(f+1),this.combineBlocks(e,l,n),s=f,o=!0;break}if(s===_&&s+1!==a){if(t)return!0;n=c+4*(s+1),this.combineBlocks(e,l,n),o=!0}}}return t?o:{success:o,score:r}}),c(r,"combineBlocks",function(e,t,o){var r=e[t].get_value(),c=e[o].get_value();return this.addFreeBlock(t),this.removeFreeBlock(o),e[t].set_value(0),e[o].set_value(r+c),r+c}),r)),cc._RF.pop()},{boot:"boot"}],boot:[function(e,t,o){"use strict";cc._RF.push(t,"004135UqTRDEoqR/NZy84bC","boot");var r={run_mode:"prod"};if(console.log("os",cc.sys.os,"platform",cc.sys.platform,"native",cc.sys.isNative,"browser",cc.sys.isBrowser,"mobile",cc.sys.isMobile),r.event=new cc.EventTarget,cc.game.on(cc.game.EVENT_HIDE,function(){r.event.emit("enter_background")}),cc.game.on(cc.game.EVENT_SHOW,function(){r.event.emit("enter_foreground")}),cc.sys.platform===cc.sys.WECHAT_GAME){var c=e("storage");"prod"===r.run_mode?c.init("block-2048-094ee2"):(wx.setEnableDebug({enableDebug:!0}),c.init("block-2048-dev-094ee2")),r.storage=c,r.launch_options=wx.getLaunchOptionsSync(),console.log("lauch options",r.launch_options)}window.ctx=r,cc._RF.pop()},{storage:"storage"}],storage:[function(e,t,o){"use strict";cc._RF.push(t,"70da0k+meNOrrPV+ioGWCEU","storage");var r={errCode:400,errMsg:"not login"},c=cc.Class({ctor:function(){this.env=null,this.open_id=null,this.db=null,this.collection=null},init:function(e){wx.cloud.init({traceUser:!0,env:e}),this.env=e,this.db=wx.cloud.database(),this.collection=this.db.collection("user_info")},login:function(e){var t=this;if(!this.open_id)return wx.cloud.callFunction({name:"login",data:{env:t.env},complete:function(o){o.errCode||(t.open_id=o.result.openid),e&&e(o)}});e&&e({openid:this.open_id})},get_current_user:function(e){null!==this.open_id?this.collection.doc(this.open_id).get({complete:e}):e&&e(r)},new_user:function(e,t){null!==this.open_id?(e.ts=this.db.serverDate(),e._id=this.open_id,this.collection.add({data:e,complete:t})):t&&t(r)},update_user:function(e,t){null!==this.open_id?(e.update_ts=this.db.serverDate(),this.collection.doc(this.open_id).update({data:e,complete:t})):t&&t(r)}});t.exports=new c,cc._RF.pop()},{}],tile:[function(e,t,o){"use strict";cc._RF.push(t,"de6b2kadxpCN4BrprzfFW4H","tile");var r={2:cc.color(238,228,218,255),4:cc.color(237,224,200,255),8:cc.color(242,177,121,255),16:cc.color(245,149,99,255),32:cc.color(246,124,95,255),64:cc.color(246,94,59,255),128:cc.color(237,207,114,255),256:cc.color(237,204,97,255),512:cc.color(237,200,80,255),1024:cc.color(237,197,63,255),2048:cc.color(237,194,46,255)},c={2:cc.color(119,110,101,255),4:cc.color(119,110,101,255),8:cc.color(119,110,101,255),16:cc.color(119,110,101,255),32:cc.color(119,110,101,255),64:cc.color(119,110,101,255),128:cc.color(119,110,101,255),256:cc.color(119,110,101,255),512:cc.color(119,110,101,255),1024:cc.color(119,110,101,255),2048:cc.color(119,110,101,255)};cc.Class({extends:cc.Component,properties:{number:{default:null,type:cc.Label},_fake_value:0},onLoad:function(){},start:function(){},get_value:function(){return parseInt(this._fake_value)},set_fake_value:function(e){this._fake_value=e},set_value:function(e){var t=e.toString();this.number.string!==t&&(this._fake_value=t,this.number.string=0===e?"":e,this.node.color=this.get_bk_color_by_value(e),this.number.node.color=this.get_text_color_by_value(e))},clone:function(){},get_bk_color_by_value:function(e){return r[e]||cc.color(207,193,179,255)},get_text_color_by_value:function(e){return c[e]||cc.color(119,110,101,255)}}),cc._RF.pop()},{}]},{},["app","boot","storage","tile"]);